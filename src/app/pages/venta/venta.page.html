<app-header></app-header>

<ion-content>
  <div class="venta-container">
    <div class="page-header">
      <h1>Punto de Venta</h1>
      <p>Registro de ventas diarias</p>
    </div>

    <!-- Información del cajero -->
    <div class="content-card cashier-info">
      <div class="info-row">
        <ion-icon name="person-circle-outline"></ion-icon>
        <span class="label">Cajero:</span>
        <span class="value">{{ cajero }}</span>
      </div>
    </div>

    <!-- Productos en venta -->
    <div class="content-card" *ngIf="productosEnVenta.length > 0">
      <h2 class="section-title">Productos en Venta</h2>

      <div class="products-table-container">
        <table class="products-table">
          <thead>
            <tr>
              <th>Código</th>
              <th>CAD</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Precio Unit.</th>
              <th>Subtotal</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of productosEnVenta; let i = index">
              <td data-label="Código">{{ obtenerCodigoBarras(p.idProducto) }}</td>
              <td data-label="CAD">{{ obtenerCAD(p.idProducto) }}</td>
              <td data-label="Descripción">{{ p.nombre }}</td>
              <td data-label="Cantidad" class="quantity-cell">
                <input
                  type="number"
                  [(ngModel)]="p.cantidad"
                  (change)="actualizarSubtotal(i)"
                  [min]="p.unidad === 'U' ? 1 : 0.001"
                  [step]="p.unidad === 'U' ? 1 : 0.001"
                  [readonly]="p.unidad === 'KG'"
                  class="quantity-input">
                <small class="unit" *ngIf="p.unidad === 'KG'">{{ p.cantidad.toFixed(3) }} kg</small>
              </td>
              <td data-label="Precio Unit." class="price">${{p.precioUnitario}}</td>
              <td data-label="Subtotal" class="subtotal-cell">
                <input
                  type="number"
                  [value]="p.subtotal"
                  (change)="actualizarCantidadPorSubtotal(i, $event)"
                  [readonly]="p.unidad === 'U'"
                  class="subtotal-input">
              </td>
              <td class="actions-cell">
                <button class="btn-delete" (click)="eliminarProducto(i)">
                  <ion-icon name="trash-outline"></ion-icon>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Agregar producto -->
    <div class="content-card">
      <h2 class="section-title">Agregar Producto</h2>

      <div class="add-product-form">
        <div class="form-row">
          <div class="form-field">
            <label>Código</label>
            <input
              #codigoInput
              type="number"
              placeholder="Código"
              [(ngModel)]="nuevoCodigo"
              (keydown.enter)="buscarProductoPorCodigo()"
              (blur)="buscarProductoPorCodigo()">
          </div>

          <div class="form-field">
            <label>CAD</label>
            <input
              #cadInput
              type="number"
              placeholder="CAD"
              [(ngModel)]="nuevoCAD"
              (keydown.enter)="buscarProductoPorCAD()"
              (blur)="buscarProductoPorCAD()">
          </div>

          <div class="form-field flex-2">
            <label>Descripción</label>
            <div class="description-box">
              <span>{{ productoActual?.nombre || 'Ingrese código o CAD' }}</span>
              <small *ngIf="productoActual" class="stock-info">
                Stock: {{ productoActual.stock }}
                <span *ngIf="productoActual.unidad === 'KG'">kg</span>
                <span *ngIf="productoActual.unidad === 'U'">unidades</span>
              </small>
            </div>
          </div>

          <div class="form-field">
            <label>Cantidad</label>
            <input
              #cantidadInput
              type="number"
              placeholder="0"
              [(ngModel)]="nuevaCantidad"
              (keydown.enter)="agregarProductoAVenta()"
              (blur)="agregarProductoAVenta()"
              [disabled]="!productoActual || productoActual.unidad === 'KG'"
              [min]="productoActual?.unidad === 'U' ? 1 : 0.001"
              [step]="productoActual?.unidad === 'U' ? 1 : 0.001">
          </div>

          <div class="form-field">
            <label>Precio</label>
            <div class="price-box" *ngIf="productoActual">
              ${{ productoActual.precio_venta }}
            </div>
          </div>

          <div class="form-field">
            <label>Subtotal</label>
            <input
              #subtotalInput
              *ngIf="productoActual?.unidad === 'KG'"
              type="number"
              placeholder="$0"
              [(ngModel)]="nuevoSubtotal"
              (change)="calcularCantidadDesdeSubtotal()"
              (keydown.enter)="agregarProductoAVenta()"
              (blur)="agregarProductoAVenta()">
            <div class="subtotal-box" *ngIf="productoActual && productoActual.unidad === 'U' && nuevaCantidad">
              ${{ (productoActual.precio_venta * nuevaCantidad).toFixed(0) }}
            </div>
          </div>

          <div class="form-field btn-field">
            <button
              class="btn-add"
              (click)="agregarProductoAVenta()"
              [disabled]="!productoActual">
              <ion-icon name="add-circle-outline"></ion-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mensaje cuando no hay productos -->
    <div class="empty-message" *ngIf="productosEnVenta.length === 0">
      <ion-icon name="barcode-outline"></ion-icon>
      <p>Escanee o ingrese el código de barras o CAD del primer producto</p>
    </div>

    <!-- Total y acciones -->
    <div class="total-section" *ngIf="productosEnVenta.length > 0">
      <div class="total-card">
        <span class="total-label">Total a pagar:</span>
        <span class="total-amount">${{ total.toFixed(0) }}</span>
      </div>

      <div class="action-buttons">
        <button class="btn-clear" (click)="limpiarVenta()">
          <ion-icon name="close-circle-outline"></ion-icon>
          Limpiar Venta
        </button>
        <button class="btn-confirm" (click)="confirmarVenta()">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          Realizar Venta
        </button>
      </div>
    </div>

    <!-- Historial de ventas -->
    <div class="content-card sales-history" *ngIf="historialVentas.length > 0">
      <div class="history-header">
        <ion-icon name="cash-outline" class="history-icon"></ion-icon>
        <h2 class="section-title">Ventas del Día</h2>
      </div>

      <div class="sales-list">
        <div class="sale-item" *ngFor="let venta of historialVentas">
          <div class="sale-icon">
            <ion-icon name="receipt-outline"></ion-icon>
          </div>
          <div class="sale-info">
            <div class="sale-header">
              <span class="folio">Folio: {{ venta.folio }}</span>
              <span class="sale-amount">{{ venta.total | currency:'CLP':'symbol-narrow':'1.0-0' }}</span>
            </div>
            <div class="sale-details">
              <span>{{ formatearFecha(venta.fecha) }}</span>
              <span class="separator">•</span>
              <span>{{ venta.cajero }}</span>
              <span class="separator">•</span>
              <span>{{ venta.productosVendidos.length }} producto(s)</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ion-content>
