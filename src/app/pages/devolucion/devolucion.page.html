<app-header></app-header>

<ion-content>
  <div class="devoluciones-container">
    <div class="page-header">
      <h1>Devoluciones</h1>
      <p>Gestión de devoluciones de ventas</p>
    </div>

    <!-- Información del cajero -->
    <div class="content-card cashier-info">
      <div class="info-row">
        <ion-icon name="person-circle-outline"></ion-icon>
        <span class="label">Cajero:</span>
        <span class="value">{{ cajero }}</span>
      </div>
    </div>

    <!-- Búsqueda de venta -->
    <div class="content-card">
      <h2 class="section-title">
        <ion-icon name="search-outline"></ion-icon>
        Buscar Venta
      </h2>

      <div class="search-form">
        <div class="form-field">
          <label>Folio de Venta</label>
          <input
            #folioInput
            type="number"
            placeholder="Ingrese número de folio"
            [(ngModel)]="folioVenta"
            (keydown.enter)="buscarVenta()">
        </div>

        <button
          class="btn-search"
          (click)="buscarVenta()"
          [disabled]="!folioVenta">
          <ion-icon name="search-outline"></ion-icon>
          Buscar Venta
        </button>
      </div>
    </div>

    <!-- Indicador de búsqueda -->
    <div class="loading-card" *ngIf="buscandoVenta">
      <ion-spinner name="circular"></ion-spinner>
      <p>Buscando venta...</p>
    </div>

    <!-- Venta encontrada -->
    <div class="content-card sale-found" *ngIf="ventaEncontrada">
      <div class="found-header">
        <ion-icon name="checkmark-circle" class="success-icon"></ion-icon>
        <h2 class="section-title">Venta Encontrada</h2>
      </div>

      <div class="sale-details">
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Folio</span>
            <span class="detail-value">{{ ventaEncontrada.folio }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Fecha</span>
            <span class="detail-value">{{ formatearFecha(ventaEncontrada.fecha) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Total</span>
            <span class="detail-value highlight">${{ ventaEncontrada.total }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Cajero</span>
            <span class="detail-value">{{ ventaEncontrada.cajero }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Método de Pago</span>
            <span class="detail-value">{{ ventaEncontrada.metodo_pago }}</span>
          </div>
        </div>

        <div class="products-section">
          <h3>Productos</h3>
          <div class="product-list">
            <div class="product-item" *ngFor="let producto of ventaEncontrada.productosVendidos">
              <div class="product-info">
                <span class="product-name">{{ producto.nombre }}</span>
                <div class="product-details">
                  <span>Cantidad: {{ producto.cantidad }}</span>
                  <span class="separator">•</span>
                  <span>Precio: ${{ producto.precioUnitario }}</span>
                  <span class="separator">•</span>
                  <span>Subtotal: ${{ producto.subtotal }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Formulario de devolución -->
    <div class="content-card refund-form" *ngIf="ventaEncontrada && !devolucionExistente">
      <h2 class="section-title">
        <ion-icon name="return-down-back-outline"></ion-icon>
        Procesar Devolución
      </h2>

      <div class="form-section">
        <div class="form-field">
          <label>Monto a Devolver</label>
          <div class="input-wrapper">
            <span class="currency-symbol">$</span>
            <input
              type="number"
              placeholder="0"
              [(ngModel)]="montoDevolucion"
              [max]="ventaEncontrada.total"
              min="1">
          </div>
          <small class="field-info">Máximo: ${{ ventaEncontrada.total }}</small>
        </div>

        <div class="error-message" *ngIf="mostrarErrorMonto()">
          <ion-icon name="warning-outline"></ion-icon>
          <span>{{ getMensajeErrorMonto() }}</span>
        </div>

        <div class="form-field">
          <label>Descripción de la Devolución</label>
          <textarea
            placeholder="Motivo de la devolución..."
            [(ngModel)]="descripcionDevolucion"
            rows="4">
          </textarea>
        </div>

        <button
          class="btn-refund"
          (click)="confirmarDevolucion()"
          [disabled]="!montoDevolucion || !descripcionDevolucion || montoDevolucion <= 0 || montoDevolucion > ventaEncontrada.total">
          <ion-icon name="return-down-back-outline"></ion-icon>
          Procesar Devolución
        </button>
      </div>
    </div>

    <!-- Devolución ya existente -->
    <div class="alert-card warning" *ngIf="ventaEncontrada && devolucionExistente">
      <ion-icon name="warning-outline" class="alert-icon"></ion-icon>
      <div class="alert-content">
        <h3>Devolución ya procesada</h3>
        <p>Ya existe una devolución registrada para el folio {{ ventaEncontrada.folio }}. No se pueden procesar múltiples devoluciones para la misma venta.</p>
      </div>
    </div>

    <!-- Venta no encontrada -->
    <div class="alert-card error" *ngIf="folioVenta && !ventaEncontrada && busquedaRealizada && !buscandoVenta">
      <ion-icon name="close-circle-outline" class="alert-icon"></ion-icon>
      <div class="alert-content">
        <p>No se encontró ninguna venta con el folio {{ folioVenta }}</p>
      </div>
    </div>

    <!-- Historial de devoluciones -->
    <div class="content-card history-card" *ngIf="historialDevoluciones.length > 0">
      <div class="history-header">
        <ion-icon name="return-down-back-outline" class="history-icon"></ion-icon>
        <h2 class="section-title">Devoluciones del Día</h2>
      </div>

      <div class="refund-list">
        <div class="refund-item" *ngFor="let devolucion of historialDevoluciones">
          <div class="refund-icon">
            <ion-icon name="arrow-back-outline"></ion-icon>
          </div>
          <div class="refund-info">
            <div class="refund-header">
              <span class="folio">Folio: {{ devolucion.folio }}</span>
              <span class="refund-amount">-${{ devolucion.monto }}</span>
            </div>
            <div class="refund-details">
              <span>{{ formatearFecha(devolucion.fecha) }}</span>
              <span class="separator">•</span>
              <span>{{ devolucion.cajero }}</span>
            </div>
            <div class="refund-description">
              {{ devolucion.descripcion }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sin devoluciones -->
    <div class="empty-message" *ngIf="historialDevoluciones.length === 0">
      <ion-icon name="return-down-back-outline"></ion-icon>
      <p>No hay devoluciones registradas hoy</p>
    </div>
  </div>
</ion-content>
