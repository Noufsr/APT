<app-header></app-header>

<ion-content>
  <div class="pedido-container">
    <div class="page-header">
      <h1>Ingresar Pedido</h1>
      <p>Gestión de pedidos a proveedores</p>
    </div>

    <!-- Sección de selección de proveedor -->
    <div class="content-card" *ngIf="!proveedorSeleccionado">
      <h2 class="section-title">Seleccionar Proveedor</h2>

      <div class="search-section">
        <div class="search-box">
          <ion-icon name="search-outline"></ion-icon>
          <input
            type="text"
            placeholder="Buscar proveedor..."
            [(ngModel)]="busquedaProveedor"
            (input)="buscarProveedor()">
        </div>

        <div class="providers-list" *ngIf="proveedoresFiltrados.length > 0">
          <div
            class="provider-item"
            *ngFor="let proveedor of proveedoresFiltrados"
            (click)="seleccionarProveedor(proveedor)">
            <ion-icon name="business-outline"></ion-icon>
            <span>{{ proveedor.nombreProveedor }}</span>
            <ion-icon name="chevron-forward-outline" class="arrow"></ion-icon>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn-primary" (click)="abrirModalNuevoProveedor()">
            <ion-icon name="add-outline"></ion-icon>
            Nuevo Proveedor
          </button>

          <button class="btn-primary" (click)="abrirModalNuevoProducto()">
            <ion-icon name="cube-outline"></ion-icon>
            Nuevo Producto
          </button>

          <button class="btn-secondary" (click)="abrirPagosPendientes()">
            <ion-icon name="cash-outline"></ion-icon>
            Pagos Pendientes
          </button>
        </div>
      </div>
    </div>

    <!-- Proveedor seleccionado -->
    <div class="content-card provider-selected" *ngIf="proveedorSeleccionado">
      <div class="provider-info">
        <div>
          <span class="label">Proveedor:</span>
          <span class="provider-name">{{ proveedorSeleccionado.nombreProveedor }}</span>
        </div>
        <button class="btn-change" (click)="cambiarProveedor()">
          <ion-icon name="swap-horizontal-outline"></ion-icon>
          Cambiar
        </button>
      </div>
    </div>

    <!-- Productos en pedido -->
    <div class="content-card" *ngIf="proveedorSeleccionado && productosEnPedido.length > 0">
      <h2 class="section-title">Productos en Pedido</h2>

      <div class="products-table-container">
        <table class="products-table">
          <thead>
            <tr>
              <th>Código</th>
              <th>CAD</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Proveedor</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of productosEnPedido; let i = index">
              <td data-label="Código">{{ obtenerCodigoBarras(p.idProducto) }}</td>
              <td data-label="CAD">{{ obtenerCAD(p.idProducto) }}</td>
              <td data-label="Descripción">{{ p.nombre }}</td>
              <td data-label="Cantidad" class="quantity-cell">
                <input
                  type="number"
                  [(ngModel)]="p.cantidad"
                  min="1"
                  class="quantity-input">
              </td>
              <td data-label="Proveedor">{{ proveedorSeleccionado.nombreProveedor }}</td>
              <td class="actions-cell">
                <button class="btn-delete" (click)="eliminarProducto(i)">
                  <ion-icon name="trash-outline"></ion-icon>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Agregar producto -->
    <div class="content-card" *ngIf="proveedorSeleccionado">
      <h2 class="section-title">Agregar Producto</h2>

      <div class="add-product-form">
        <div class="form-row">
          <div class="form-field">
            <label>Código de Barras</label>
            <input
              #codigoInput
              type="number"
              placeholder="Ingrese código"
              [(ngModel)]="nuevoCodigo"
              (keydown.enter)="buscarProductoPorCodigo()">
          </div>

          <div class="form-field">
            <label>CAD</label>
            <input
              #cadInput
              type="number"
              placeholder="Ingrese CAD"
              [(ngModel)]="nuevoCAD"
              (keydown.enter)="buscarProductoPorCAD()">
          </div>

          <div class="form-field flex-2">
            <label>Descripción</label>
            <div class="description-box">
              {{ productoActual?.nombre || 'Ingrese código o CAD' }}
            </div>
          </div>

          <div class="form-field">
            <label>Cantidad</label>
            <input
              #cantidadInput
              type="number"
              placeholder="0"
              [(ngModel)]="nuevaCantidad"
              (keydown.enter)="agregarProductoAlPedido()"
              [disabled]="!productoActual"
              min="1">
          </div>

          <div class="form-field btn-field">
            <button
              class="btn-add"
              (click)="agregarProductoAlPedido()"
              [disabled]="!productoActual">
              <ion-icon name="add-circle-outline"></ion-icon>
              Agregar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Botón confirmar pedido -->
    <div class="confirm-section" *ngIf="proveedorSeleccionado && productosEnPedido.length > 0">
      <button class="btn-confirm" (click)="confirmarPedido()">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        Confirmar Pedido
      </button>
    </div>
  </div>
  <app-footer></app-footer>
</ion-content>
